<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../../../../webjars/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/css/ol.css" type="text/css">
    <link rel="stylesheet" href="../../../css/main.css" >

    <title>deegree - OGC API Features 1.0 - Feature</title>

    <style>
      [v-cloak] {
        display: none;
      }
      tr {
        line-height: 1;
      }
      .map {
        height: 480px;
        width: 540px;
      }
      #info {
        position: absolute;
        z-index: 100;
      }
      .tooltip-inner {
        max-width: 100%;
      }
      #popup-content {
        font-size: smaller;
      }
      .ol-popup {
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "âœ–";
      }
    </style>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="../../../../../webjars/jquery/3.4.1/jquery.min.js"></script>
    <script src="../../../../../webjars/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="../../../../../webjars/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="../../../../../webjars/vue/2.6.11/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.1/proj4.js" ></script>
</head>
<body>

<header>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"></a>
            <ul class="nav" id="breadcrump">
                <li class="breadcrumb-item">
                    <a v-bind:href="datasetsLink">Datasets</a>
                </li>
                <li class="breadcrumb-item">
                    <a v-cloak v-bind:href="datasetLink">{{ datasetName }}</a>
                </li>
                <li class="breadcrumb-item">
                    <a v-bind:href="collectionsLink">Collections</a>
                </li>
                <li v-cloak class="breadcrumb-item">
                    <a v-bind:href="collectionLink">{{ collectionId }}</a>
                </li>
                <li class="breadcrumb-item">
                    <a v-bind:href="itemsLink">Features</a>
                </li>
                <li v-cloak class="breadcrumb-item active" aria-current="page">{{ featureId }}</li>
            </ul>
            <ul class="nav justify-content-end">
              <li class="nav-item">
                  <a class="nav-link" href="?f=json" target="_blank">GeoJSON</a>
              </li>
              <li class="nav-item">
                  <a class="nav-link" href="?f=xml" target="_blank">GML</a>
              </li>
              <li class="nav-item">
                  <a class="nav-link disabled" href="?f=html" tabindex="-1" aria-disabled="true" target="_blank">HTML</a>
              </li>
            </ul>
        </div>
    </nav>
</header>

<div class="container" id="content">
    <div>
        <div class="row">
            <div class="col" v-if="!isItemAvailable">
                <h3 v-cloak class="mt-5">Feature with ID {{ featureId }} is not known</h3>
            </div>
            <div class="col" v-else>
                <h3 v-cloak class="mt-5">{{ featureId }}</h3>
            </div>
        </div>
        <hr/>
        <div class="row justify-content-between">
            <div class="col-md" v-if="isItemAvailable" >
                <div class="row mt-2">
                    <div class="col">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th scope="col">Attribute</th>
                                <th scope="col">Value</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="(property, attribute) in properties">
                                <td v-cloak>{{ attribute }}</td>
                                <td v-cloak>{{ property }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md">
                <div id="map" class="map">
                    <div id="info"></div>
                    <!--
                    <div id="popup" class="ol-popup">
                        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                        <div id="popup-content"></div>
                    </div>
                    -->
                </div>
            </div>
        </div>

        <div class="row" v-if="isItemAvailable">
                <div class="col-sm-2">Links</div>
                <div class="col-md-10">
                    <div v-for="link in links">
                        <a v-cloak v-if="link.type == 'text/html' && link.rel != 'alternate'" v-bind:href="link.href" >{{ link.title }}</a>
                    </div>
                </div>
        </div>
    </div>
</div>

<footer class="page-footer" id="footer">
    <div v-if="impressumUrl && impressumUrl.length > 0" >
        <a v-cloak v-bind:href="impressumUrl"  target="_blank" class="impressum"> Impressum</a>
    </div>
    <div v-else >
        <a href="https://deegree-enterprise.de"  target="_blank" class="impressum"> deegree Enterprise Edition</a>
    </div>
</footer>

<script>
removeTrailingSlash();

var App = new Vue({
  el: '#content',
  data: {
    featureId: '',
    properties: '',
    links: '',
    isItemAvailable: false
  },

  created() {
    this.fetchData().catch(error => {
      console.error(error)
    })
  },
  methods: {
    async fetchData() {
      var baseUrl = retrieveBaseUrl();
      const response = await fetch( baseUrl, {headers: {'Accept': 'application/geo+json' } } );
      const json = await response.json();

      this.isItemAvailable = json.features;

      if( this.isItemAvailable ){
        this.featureId = json.features[0].id;
        this.properties = json.features[0].properties;
        this.links = json.links;
        fetchConfigAndSetFeature(json);
      } else {
        document.getElementById('map').style.display='none';
        this.featureId = baseUrl.substring(baseUrl.lastIndexOf("/") + 1);
      }
    }
  }
})

var AppBreadcrump = new Vue({
  el: '#breadcrump',
  data: {
    collectionId: '',
    featureId: '',
    datasetLink: '',
    datasetName: '',
    datasetsLink: '',
    collectionsLink: '',
    collectionLink: '',
    itemsLink: ''
  },

  created() {
    var self = this;
    var thisLink = window.location.href.endsWith("/") ? window.location.href.substring(0, window.location.href.length -1) : window.location.href;
    self.itemsLink = thisLink.substring(0, thisLink.lastIndexOf("/"));
    self.featureId = thisLink.substring(thisLink.lastIndexOf("/") + 1);
    self.collectionLink = self.itemsLink.substring(0, self.itemsLink.lastIndexOf("/"));
    self.collectionsLink = self.collectionLink.substring(0, self.collectionLink.lastIndexOf("/"));
    self.datasetLink = self.collectionsLink.substring(0, self.collectionsLink.lastIndexOf("/"));
    self.datasetName = self.datasetLink.substring(self.datasetLink.lastIndexOf("/") + 1);
    self.datasetsLink = self.datasetLink.substring(0, self.datasetLink.lastIndexOf("/"));


    $.ajax({
      dataType: "json",
      //url: "http://localhost:8002/collections/strassenbaumkataster",
      url: self.collectionLink,
      success: function(data) {
        self.collectionId = data.title;
      }
    });
  }
})

var footerApp = new Vue({
  el: '#footer',
  data: {
    impressumUrl: ''
  },

  created() {
    // create a closure to access component in the callback below
    var self = this;

    $.ajax({
      dataType: "json",
      url: createImpressumUrl(),
      success: function(data) {
        self.impressumUrl = data.impressumUrl;
      }
    });
  }
})

function removeTrailingSlash(){
  if( window.location.href.endsWith("/") ){
    window.location.href = window.location.href.substring(0, window.location.href.length -1);
  }
}

var styles = [
  new ol.style.Style({
    image: new ol.style.Circle({
      radius: 6,
      fill: new ol.style.Fill({
        color: 'rgba(0,0,255, 0.1)'
      }),
      stroke: new ol.style.Stroke({
        color: 'rgba(0,0,255, 1)',
        width: 2
      })
    }),
    stroke: new ol.style.Stroke({
      color: 'rgba(0,0,255, 1)',
      width: 3
    }),
    fill: new ol.style.Fill({
      color: 'rgba(0, 0, 255, 0.1)'
    })
  })
];

async function fetchConfigAndSetFeature(featureJson) {
  var configUrl = createMapConfigUrl();

  const response = await fetch( configUrl, {headers: {'Accept': 'application/json' } } );
  if( response.status == 200 ){
    const json = await response.json();
    setMapBackgroundAndFeature(json.wmsUrl, json.wmsLayers, json.crsCode, json.crsProj4Definition, featureJson);
  } else {
    setMapBackgroundAndFeature('http://sg.geodatenzentrum.de/wms_dtk250', 'dtk250', null, null, featureJson);
  }
}

function setMapBackgroundAndFeature(wmsUrl, wmsLayers, crsCode, projDef, featureJson){
    var crsCodeRegistered = registerCrs(crsCode, projDef);
    if( crsCodeRegistered ){
        var userConfig = ol.proj.get(crsCode);
        map.setView(
            new ol.View({
                projection: userConfig,
                constrainResolution: true
            })
        );
    }

    var wmsLayer = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: wmsUrl,
        params: {'VERSION': '1.1.1', 'LAYERS': wmsLayers, 'TILED': true}
      })
    });
    map.getLayers().insertAt(0, wmsLayer);
    setFeature(featureJson, crsCode);
}

function setFeature(featureJson, crsCode){
  featureSource.clear();
  featureSource.addFeatures(featureSource.getFormat().readFeatures(featureJson, {
                    "dataProjection" : "EPSG:4326",
                    "featureProjection" : crsCode
             }));

  var extentGeom = ol.geom.Polygon.fromExtent(featureSource.getExtent())
  extentGeom.scale(1.2);
  map.getView().fit(extentGeom.getExtent(), {'maxZoom':20, 'nearest': true } );
}

var featureSource = new ol.source.Vector({
  format: new ol.format.GeoJSON(),
  strategy: ol.loadingstrategy.all
});

var featureLayer = new ol.layer.Vector({
  source: featureSource,
  style: styles
});

var map = new ol.Map({
  target: 'map',
  layers: [
    featureLayer
  ],
  view: new ol.View({
    projection: 'EPSG:4326',
    center: [10.0143, 53.5537],
    zoom: 14,
    constrainResolution: true
  })
});

var info = $('#info');
info.tooltip({
  animation: false,
  trigger: 'manual'
});

var displayTooltip = function(pixel) {
  info.css({
    left: (pixel[0] + 15) + 'px',
    top: (pixel[1] - 15) + 'px'
  });
  var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
    return feature;
  });
  if (feature) {
    info.tooltip('hide')
      .attr('data-original-title', feature.getId())
      .tooltip('show');
  } else {
    info.tooltip('hide');
  }
};

map.on('pointermove', function(evt) {
  if (evt.dragging) {
    info.tooltip('hide');
    return;
  }
  displayTooltip(evt.pixel);
});
/*
var container = document.getElementById('popup');
var content = document.getElementById('popup-content');
var closer = document.getElementById('popup-closer');

var overlay = new ol.Overlay({
  element: container,
  autoPan: true,
  autoPanAnimation: {
    duration: 250
  }
});
map.addOverlay(overlay);

closer.onclick = function() {
  overlay.setPosition(undefined);
  select.getFeatures().clear();
  closer.blur();
  return false;
};

var clickCoordinate;
map.on('singleclick', function(evt) {
  clickCoordinate = evt.coordinate;
});

var select = new ol.interaction.Select();
map.addInteraction(select);
select.on('select', function(e) {
  var feature = e.selected[0];
  var keys = feature.getKeys();
  var geometryName = feature.getGeometryName();
  var html = '<table>';
  for (i = 0; i < keys.length; i++){
    var key = keys[i];
    if (key != geometryName){
      html = html + '<tr><th>' + key + '</th><th>' + feature.get(key) + '</th></tr>';
    }
  }
  html = html + '</table>';
  content.innerHTML = '<div><h6>' + feature.getId() + '</h6></div><div>' + html + '</div>';
  overlay.setPosition(clickCoordinate);
});
*/
function createImpressumUrl(){
  return createConfigUrl("/config/impressum");
}

function createMapConfigUrl(){
  return createConfigUrl("/config/map");
}

function createConfigUrl(path){
  var baseUrl = window.location.href;
  var indexIncludeDataset = (baseUrl.lastIndexOf("dataset") + 9)
  var indexOfDatasetId = baseUrl.substring(indexIncludeDataset, baseUrl.length ).indexOf( "/" ) + indexIncludeDataset;
  var configUrl = baseUrl.substring ( 0, indexOfDatasetId ) + path;
  return configUrl;
}

function registerCrs(crsCode, projDef){
   if( crsCode != null &&  projDef != null ) {
       proj4.defs(crsCode, projDef);
       ol.proj.proj4.register(proj4);
       return true;
   }
   return false;
}

function retrieveBaseUrl() {
      var featuresRefWithoutQuery = window.location.href;
      if ( featuresRefWithoutQuery.indexOf('?') >= 0 ) {
        featuresRefWithoutQuery = featuresRefWithoutQuery.substr(0, featuresRefWithoutQuery.indexOf('?'));
      }
      return featuresRefWithoutQuery;
}
</script>
</body>
</html>